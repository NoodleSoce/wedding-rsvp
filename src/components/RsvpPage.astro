---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const redirectUrl = lang === "ar" ? "/ar/countdown" : "/countdown";
---

<Layout title={lang === "ar" ? "تأكيد الحضور" : "RSVP"} lang={lang}>
    <main class="page fade-in">
        <div class="page-content">
            <div class="card">
                <h2 class="title anim anim-1">{t["rsvp.title"]}</h2>
                <p class="subtitle anim anim-2">{t["rsvp.subtitle"]}</p>

                <form id="form" class="anim anim-3" data-redirect={redirectUrl}>
                    <a href={redirectUrl} data-astro-prefetch="load" hidden></a>

                    <div class="field">
                        <label class="label" for="name">{t["rsvp.name"]}</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="input"
                            required
                            placeholder={t["rsvp.namePlaceholder"]}
                            autocomplete="name"
                            autocapitalize="words"
                        />
                    </div>

                    <div class="field">
                        <label class="label">{t["rsvp.attending"]}</label>
                        <div class="options">
                            <label class="option">
                                <input
                                    type="radio"
                                    name="attending"
                                    value="yes"
                                    checked
                                />
                                <span class="option-label accept"
                                    >{t["rsvp.accept"]}</span
                                >
                            </label>
                            <label class="option">
                                <input
                                    type="radio"
                                    name="attending"
                                    value="no"
                                />
                                <span class="option-label decline"
                                    >{t["rsvp.decline"]}</span
                                >
                            </label>
                        </div>
                    </div>

                    <div id="guests-wrap" class="expand expanded">
                        <div class="field">
                            <label class="label" for="guests"
                                >{t["rsvp.guests"]}</label
                            >
                            <input
                                type="number"
                                id="guests"
                                name="guests"
                                class="input"
                                min="0"
                                max="9"
                                value="0"
                                inputmode="numeric"
                            />
                        </div>
                    </div>

                    <button type="submit" class="btn">{t["rsvp.submit"]}</button
                    >
                    <p id="error" class="error hidden">{t["rsvp.error"]}</p>
                </form>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="loader hidden">
            <div class="spinner"></div>
            <svg
                class="check"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
            >
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <p id="loader-text">{t["rsvp.sending"]}</p>
        </div>
    </main>
</Layout>

<script>
    import { navigate } from "astro:transitions/client";

    const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwq4PjP3sAEj2YTMTge5tZkwDx447v4T-0ySATyf3GImmpnZTaop-NGoxFj-lSyGnTl/exec";
    const STORAGE_KEY = "rsvp_form";

    document.addEventListener("astro:page-load", () => {
        const form = document.getElementById("form") as HTMLFormElement;
        if (!form) return;

        const name = document.getElementById("name") as HTMLInputElement;
        const guests = document.getElementById("guests") as HTMLInputElement;
        const guestsWrap = document.getElementById("guests-wrap");
        const radios = document.getElementsByName("attending");
        const loader = document.getElementById("loader");
        const loaderText = document.getElementById("loader-text");
        const error = document.getElementById("error");
        const redirectUrl = form.dataset.redirect || "/countdown";

        // Reset state
        const reset = () => {
            loader?.classList.add("hidden");
            loader?.classList.remove("success");
            error?.classList.add("hidden");
        };
        reset();
        window.addEventListener("pageshow", reset);

        // Guest visibility
        const updateGuests = (hide: boolean) => {
            guestsWrap?.classList.toggle("expanded", !hide);
        };

        // Load saved data
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (name) name.value = data.name || "";
                if (guests) guests.value = data.guests || "0";
                if (data.attending) {
                    const radio = document.querySelector(
                        `input[value="${data.attending}"]`,
                    ) as HTMLInputElement;
                    if (radio) {
                        radio.checked = true;
                        updateGuests(data.attending === "no");
                    }
                }
            } catch {}
        }

        // Save form data
        let timeout: ReturnType<typeof setTimeout>;
        const save = () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const radio = document.querySelector(
                    'input[name="attending"]:checked',
                ) as HTMLInputElement;
                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        name: name?.value || "",
                        attending: radio?.value || "yes",
                        guests: guests?.value || "0",
                    }),
                );
            }, 400);
        };

        name?.addEventListener("input", save);
        guests?.addEventListener("input", () => {
            if (guests.value.length > 1) guests.value = guests.value.slice(-1);
            if (!/^[0-9]?$/.test(guests.value)) guests.value = "0";
            save();
        });

        radios.forEach((r) =>
            r.addEventListener("change", (e) => {
                updateGuests((e.target as HTMLInputElement).value === "no");
                save();
            }),
        );

        // Submit
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            loader?.classList.remove("hidden");
            error?.classList.add("hidden");

            const attending =
                (
                    document.querySelector(
                        'input[name="attending"]:checked',
                    ) as HTMLInputElement
                )?.value === "yes";
            const data = {
                name: name?.value.trim() || "",
                attending: attending ? "Yes" : "No",
                guests: attending ? Number(guests?.value || 0) : 0,
            };

            try {
                await fetch(SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(data),
                });

                localStorage.removeItem(STORAGE_KEY);
                loader?.classList.add("success");
                if (loaderText) loaderText.textContent = "✓";
                setTimeout(() => navigate(redirectUrl), 800);
            } catch {
                error?.classList.remove("hidden");
                loader?.classList.add("hidden");
            }
        });
    });
</script>

<style>
    .title {
        font-size: var(--fs-2xl);
        font-style: italic;
        text-align: center;
        margin-bottom: var(--s-1);
    }

    .subtitle {
        text-align: center;
        color: var(--c-white-80);
        font-size: var(--fs-sm);
        margin-bottom: var(--s-6);
    }

    .field {
        margin-bottom: var(--s-4);
    }

    .options {
        display: flex;
        gap: var(--s-2);
    }

    .option {
        flex: 1;
        cursor: pointer;
    }

    .option input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .option-label {
        display: block;
        padding: var(--s-3);
        text-align: center;
        background: var(--c-white-10);
        border: 1px solid var(--c-white-20);
        border-radius: var(--s-2);
        font-size: var(--fs-base);
        transition: all var(--transition);
    }

    .option input:checked + .accept {
        background: var(--c-success);
        border-color: var(--c-success);
        font-weight: 600;
        box-shadow: 0 0 12px rgba(46, 125, 50, 0.4);
    }

    .option input:checked + .decline {
        background: var(--c-error);
        border-color: var(--c-error);
        font-weight: 600;
        box-shadow: 0 0 12px rgba(198, 40, 40, 0.4);
    }

    .expand {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.35s ease;
    }

    .expand.expanded {
        grid-template-rows: 1fr;
    }

    .expand > * {
        overflow: hidden;
    }

    .btn {
        margin-top: var(--s-4);
    }

    .error {
        text-align: center;
        color: #fcc;
        font-size: var(--fs-sm);
        margin-top: var(--s-4);
    }

    /* Loader */
    .loader {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(75, 1, 1, 0.95);
        z-index: 9999;
        transition: opacity 0.2s;
    }

    .loader.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .spinner {
        width: 2.5rem;
        height: 2.5rem;
        border: 3px solid var(--c-white-20);
        border-top-color: var(--c-white);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-bottom: var(--s-4);
    }

    .check {
        width: 3rem;
        height: 3rem;
        color: #4ade80;
        margin-bottom: var(--s-4);
        display: none;
    }

    .loader.success .spinner {
        display: none;
    }
    .loader.success .check {
        display: block;
        animation: pop 0.3s ease;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes pop {
        from {
            transform: scale(0);
        }
        to {
            transform: scale(1);
        }
    }
</style>
