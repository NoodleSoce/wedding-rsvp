---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const redirectUrl = lang === "ar" ? "/ar/countdown" : "/countdown";
---

<Layout title={lang === "ar" ? "تأكيد الحضور" : "RSVP"} lang={lang}>
    <main class="rsvp-page fade" id="rsvp-page">
        <div class="form-wrap" id="form-wrap">
            <div class="card form-card" id="form-card">
                <form id="form" data-redirect={redirectUrl}>
                    <a href={redirectUrl} data-astro-prefetch="load" hidden></a>

                    <div class="field">
                        <label class="label" for="name">{t["rsvp.name"]}</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="input"
                            required
                            placeholder={t["rsvp.namePlaceholder"]}
                            autocomplete="name"
                            autocapitalize="words"
                        />
                    </div>

                    <div class="field">
                        <span class="label">{t["rsvp.attending"]}</span>
                        <div class="radio-row">
                            <label class="radio-label">
                                <input
                                    type="radio"
                                    name="attending"
                                    value="yes"
                                    id="att-yes"
                                    checked
                                />
                                <span class="radio-btn yes"
                                    >{t["rsvp.accept"]}</span
                                >
                            </label>
                            <label class="radio-label">
                                <input
                                    type="radio"
                                    name="attending"
                                    value="no"
                                    id="att-no"
                                />
                                <span class="radio-btn no"
                                    >{t["rsvp.decline"]}</span
                                >
                            </label>
                        </div>
                    </div>

                    <div id="guests-section" class="guests-section open">
                        <div class="field">
                            <label class="label" for="guests"
                                >{t["rsvp.guests"]}</label
                            >
                            <input
                                type="number"
                                id="guests"
                                name="guests"
                                class="input"
                                min="0"
                                max="9"
                                value="0"
                                inputmode="numeric"
                            />
                        </div>
                    </div>

                    <button type="submit" class="btn submit-btn" id="submit-btn"
                        >{t["rsvp.submit"]}</button
                    >
                    <p id="error-msg" class="error-msg" hidden>
                        {t["rsvp.error"]}
                    </p>
                </form>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-content">
                <div id="spinner" class="spinner"></div>
                <svg
                    id="checkmark"
                    class="checkmark"
                    viewBox="0 0 52 52"
                    style="display: none;"
                >
                    <circle
                        class="checkmark-circle"
                        cx="26"
                        cy="26"
                        r="24"
                        fill="none"></circle>
                    <path
                        class="checkmark-check"
                        fill="none"
                        d="M14 27l8 8 16-16"></path>
                </svg>
            </div>
        </div>
    </main>
</Layout>

<script>
    const API =
        "https://script.google.com/macros/s/AKfycbwq4PjP3sAEj2YTMTge5tZkwDx447v4T-0ySATyf3GImmpnZTaop-NGoxFj-lSyGnTl/exec";
    const KEY = "rsvp";

    function init() {
        const form = document.getElementById("form") as HTMLFormElement | null;
        if (!form) return;

        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const nameEl = document.getElementById("name") as HTMLInputElement;
        const guestsEl = document.getElementById("guests") as HTMLInputElement;
        const guestsSection = document.getElementById("guests-section");
        const radios = document.querySelectorAll<HTMLInputElement>(
            'input[name="attending"]',
        );
        const errorMsg = document.getElementById("error-msg");
        const loadingOverlay = document.getElementById("loading-overlay");
        const spinner = document.getElementById("spinner");
        const checkmark = document.getElementById("checkmark");
        const redirect = form.dataset.redirect || "/countdown";

        let keyboardOpen = false;

        function resetState() {
            if (loadingOverlay) loadingOverlay.classList.remove("visible");
            if (spinner) {
                spinner.style.display = "";
                spinner.classList.remove("fade-out");
            }
            if (checkmark) {
                checkmark.style.display = "none";
                checkmark.classList.remove("animate");
            }
            if (errorMsg) errorMsg.hidden = true;
            if (submitBtn) submitBtn.disabled = false;
        }
        resetState();
        window.addEventListener("pageshow", resetState);

        function scrollToShowForm() {
            setTimeout(() => {
                submitBtn?.scrollIntoView({ behavior: "smooth", block: "end" });
            }, 150);
        }

        let lastHeight = window.visualViewport?.height || window.innerHeight;

        if (window.visualViewport) {
            window.visualViewport.addEventListener("resize", () => {
                const currentHeight = window.visualViewport!.height;

                if (currentHeight > lastHeight + 100) {
                    const active = document.activeElement as HTMLElement;
                    if (active === nameEl || active === guestsEl) {
                        active.blur();
                        keyboardOpen = false;
                        window.scrollTo({ top: 0, behavior: "smooth" });
                    }
                }

                lastHeight = currentHeight;
            });
        }

        nameEl?.addEventListener("focus", () => {
            keyboardOpen = true;
            scrollToShowForm();
        });

        guestsEl?.addEventListener("focus", () => {
            keyboardOpen = true;
            scrollToShowForm();
            // Delay select to let keyboard fully open first
            setTimeout(() => guestsEl.select(), 50);
        });

        function handleBlur() {
            setTimeout(() => {
                const active = document.activeElement;
                const isInForm =
                    active?.closest("#form") || active?.closest(".radio-label");

                if (!isInForm) {
                    keyboardOpen = false;
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }
            }, 100);
        }

        nameEl?.addEventListener("blur", handleBlur);
        guestsEl?.addEventListener("blur", handleBlur);

        function getAttending() {
            return (
                (
                    document.querySelector(
                        'input[name="attending"]:checked',
                    ) as HTMLInputElement
                )?.value || "yes"
            );
        }

        function updateGuestsVisibility() {
            const show = getAttending() === "yes";
            guestsSection?.classList.toggle("open", show);
        }

        radios.forEach((r) => {
            r.addEventListener("change", () => {
                updateGuestsVisibility();
                saveData();

                if (keyboardOpen) {
                    nameEl?.focus();
                }
            });
        });

        try {
            const saved = JSON.parse(localStorage.getItem(KEY) || "{}");
            if (saved.name && nameEl) nameEl.value = saved.name;
            if (saved.guests && guestsEl) guestsEl.value = saved.guests;
            if (saved.attending) {
                const r = document.querySelector(
                    `input[value="${saved.attending}"]`,
                ) as HTMLInputElement;
                if (r) r.checked = true;
            }
            updateGuestsVisibility();
        } catch {}

        let saveTimeout: ReturnType<typeof setTimeout>;
        function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem(
                    KEY,
                    JSON.stringify({
                        name: nameEl?.value || "",
                        attending: getAttending(),
                        guests: guestsEl?.value || "0",
                    }),
                );
            }, 200);
        }

        nameEl?.addEventListener("input", saveData);

        guestsEl?.addEventListener("input", () => {
            let v = guestsEl.value.replace(/\D/g, "");
            if (v.length > 1) v = v.slice(-1);
            guestsEl.value = v || "0";
            saveData();
        });

        let isSubmitting = false;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Prevent double submit
            if (isSubmitting) return;
            isSubmitting = true;

            (document.activeElement as HTMLElement)?.blur();
            keyboardOpen = false;

            if (loadingOverlay) loadingOverlay.classList.add("visible");
            if (spinner) {
                spinner.style.display = "";
                spinner.classList.remove("fade-out");
            }
            if (checkmark) {
                checkmark.style.display = "none";
                checkmark.classList.remove("animate");
            }
            if (errorMsg) errorMsg.hidden = true;
            if (submitBtn) submitBtn.disabled = true;

            const isAttending = getAttending() === "yes";

            // Store decline status for countdown page
            sessionStorage.setItem(
                "rsvp_declined",
                isAttending ? "false" : "true",
            );

            try {
                await fetch(API, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify({
                        name: nameEl?.value.trim() || "",
                        attending: isAttending ? "Yes" : "No",
                        guests: isAttending ? +(guestsEl?.value || 0) : 0,
                    }),
                });

                localStorage.removeItem(KEY);

                if (spinner) spinner.classList.add("fade-out");

                setTimeout(() => {
                    if (spinner) spinner.style.display = "none";
                    if (checkmark) {
                        checkmark.style.display = "";
                        checkmark.classList.add("animate");
                    }
                }, 300);

                // Navigate using the prefetched link (more reliable than navigate())
                setTimeout(() => {
                    const link = form.querySelector(
                        "a[data-astro-prefetch]",
                    ) as HTMLAnchorElement;
                    if (link) {
                        link.click();
                    } else {
                        window.location.href = redirect;
                    }
                }, 900);
            } catch {
                if (loadingOverlay) loadingOverlay.classList.remove("visible");
                if (errorMsg) errorMsg.hidden = false;
                if (submitBtn) submitBtn.disabled = false;
            }
        });
    }

    init();
    document.addEventListener("astro:page-load", init);
</script>

<style>
    /* RSVP page - scrollable, content doesn't overlap header */
    .rsvp-page {
        min-height: 100vh;
        min-height: 100dvh;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: var(--header-h) var(--page-pad) var(--page-pad);
        background: var(--bg);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    @media (orientation: landscape) and (max-height: 500px) {
        .rsvp-page {
            align-items: flex-start;
            padding-top: calc(var(--header-h) + var(--space-2));
        }
    }

    .form-wrap {
        width: 100%;
        max-width: var(--max-w);
    }

    .form-card {
        width: 100%;
        padding: var(--space-6);
        background: var(--white-10);
        border: 1px solid var(--white-20);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .field {
        margin-bottom: var(--space-5);
    }

    .label {
        display: block;
        font-size: var(--fs-base);
        font-weight: 500;
        color: var(--white-90);
        margin-bottom: var(--space-2);
        text-align: start;
    }

    .input {
        width: 100%;
        min-height: 54px;
        padding: var(--space-4);
        font: inherit;
        font-size: 16px;
        color: var(--white);
        background: rgba(0, 0, 0, 0.15);
        border: 1px solid var(--white-20);
        border-radius: var(--radius-sm);
        -webkit-appearance: none;
        appearance: none;
        text-align: start;
    }

    .input::placeholder {
        color: var(--white-50);
        text-align: start;
    }

    .input:focus {
        outline: none;
        border-color: var(--white-70);
    }

    .input[type="number"] {
        text-align: center;
    }

    .radio-row {
        display: flex;
        gap: var(--space-3);
    }

    .radio-label {
        flex: 1;
        cursor: pointer;
    }

    .radio-label input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .radio-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 52px;
        padding: var(--space-4);
        font-size: var(--fs-base);
        font-weight: 600;
        color: var(--white);
        background: var(--white-10);
        border: 1px solid var(--white-20);
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
    }

    .radio-label:active .radio-btn {
        transform: scale(0.97);
    }

    .radio-label input:checked + .yes {
        background: var(--success);
        border-color: var(--success);
    }

    .radio-label input:checked + .no {
        background: var(--error);
        border-color: var(--error);
    }

    .guests-section {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.2s ease;
    }

    .guests-section.open {
        grid-template-rows: 1fr;
    }

    .guests-section > * {
        overflow: hidden;
    }

    .submit-btn {
        width: 100%;
        min-height: 54px;
        margin-top: var(--space-2);
        padding: var(--space-4) var(--space-6);
        font: inherit;
        font-size: var(--fs-lg);
        font-weight: 500;
        color: var(--white);
        background: var(--white-10);
        border: 1px solid var(--white-20);
        border-radius: var(--radius-full);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .submit-btn:active {
        transform: scale(0.97);
        background: var(--white-20);
    }

    .submit-btn:disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .error-msg {
        text-align: center;
        color: #f99;
        font-size: var(--fs-base);
        margin-top: var(--space-4);
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(75, 1, 1, 0.96);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.2s ease,
            visibility 0.2s ease;
    }

    .loading-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .loading-content {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .spinner {
        width: 52px;
        height: 52px;
        border: 3px solid var(--white-20);
        border-top-color: var(--white);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
        transition: opacity 0.3s ease;
        flex-shrink: 0;
    }

    .spinner.fade-out {
        opacity: 0;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .checkmark {
        width: 52px;
        height: 52px;
        flex-shrink: 0;
    }

    .checkmark-circle {
        stroke: #4ade80;
        stroke-width: 2;
        stroke-dasharray: 151;
        stroke-dashoffset: 151;
    }

    .checkmark-check {
        stroke: #4ade80;
        stroke-width: 3;
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke-dasharray: 36;
        stroke-dashoffset: 36;
    }

    .checkmark.animate .checkmark-circle {
        animation: checkCircle 0.5s ease forwards;
    }

    .checkmark.animate .checkmark-check {
        animation: checkMark 0.3s ease forwards;
        animation-delay: 0.2s;
    }

    @keyframes checkCircle {
        to {
            stroke-dashoffset: 0;
        }
    }

    @keyframes checkMark {
        to {
            stroke-dashoffset: 0;
        }
    }
</style>
