---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const redirectUrl = lang === "ar" ? "/ar/countdown" : "/countdown";
---

<Layout title={lang === "ar" ? "تأكيد الحضور" : "RSVP"} lang={lang}>
    <main class="page fade" id="rsvp-page">
        <div class="content">
            <div class="card form-card" id="form-card">
                <form id="form" data-redirect={redirectUrl}>
                    <a
                        href={redirectUrl}
                        data-astro-prefetch="load"
                        hidden
                        aria-hidden="true"></a>

                    <label class="field" id="name-field">
                        <span class="label">{t["rsvp.name"]}</span>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="input"
                            required
                            placeholder={t["rsvp.namePlaceholder"]}
                            autocomplete="name"
                            autocapitalize="words"
                            enterkeyhint="next"
                        />
                    </label>

                    <div class="field" id="attending-field">
                        <span class="label">{t["rsvp.attending"]}</span>
                        <div class="radio-group">
                            <label class="radio">
                                <input
                                    type="radio"
                                    name="attending"
                                    value="yes"
                                    checked
                                />
                                <span class="radio-btn yes"
                                    >{t["rsvp.accept"]}</span
                                >
                            </label>
                            <label class="radio">
                                <input
                                    type="radio"
                                    name="attending"
                                    value="no"
                                />
                                <span class="radio-btn no"
                                    >{t["rsvp.decline"]}</span
                                >
                            </label>
                        </div>
                    </div>

                    <div id="guests-wrap" class="guests-wrap show">
                        <label class="field" id="guests-field">
                            <span class="label">{t["rsvp.guests"]}</span>
                            <input
                                type="number"
                                id="guests"
                                name="guests"
                                class="input"
                                min="0"
                                max="9"
                                value="0"
                                inputmode="numeric"
                                enterkeyhint="done"
                            />
                        </label>
                    </div>

                    <button type="submit" class="btn submit" id="submit-btn"
                        >{t["rsvp.submit"]}</button
                    >
                    <p id="error" class="error hidden" role="alert">
                        {t["rsvp.error"]}
                    </p>
                </form>
            </div>
        </div>

        <!-- Loader overlay -->
        <div id="loader" class="loader hidden" aria-live="polite">
            <div class="spinner" id="spinner"></div>
            <p class="sent-text" id="sent-text">{t["rsvp.sent"]}</p>
        </div>
    </main>
</Layout>

<script>
    import { navigate } from "astro:transitions/client";

    const API =
        "https://script.google.com/macros/s/AKfycbwq4PjP3sAEj2YTMTge5tZkwDx447v4T-0ySATyf3GImmpnZTaop-NGoxFj-lSyGnTl/exec";
    const KEY = "rsvp";

    function init() {
        const form = document.getElementById("form") as HTMLFormElement;
        if (!form) return;

        const page = document.getElementById("rsvp-page");
        const formCard = document.getElementById("form-card");
        const nameInput = document.getElementById("name") as HTMLInputElement;
        const guestsInput = document.getElementById(
            "guests",
        ) as HTMLInputElement;
        const guestsWrap = document.getElementById("guests-wrap");
        const radios = document.querySelectorAll<HTMLInputElement>(
            'input[name="attending"]',
        );
        const loader = document.getElementById("loader");
        const spinner = document.getElementById("spinner");
        const sentText = document.getElementById("sent-text");
        const error = document.getElementById("error");
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const redirect = form.dataset.redirect || "/countdown";

        // Check if keyboard is likely open
        let isKeyboardOpen = false;

        // Reset UI state
        function reset() {
            loader?.classList.add("hidden");
            loader?.classList.remove("done");
            error?.classList.add("hidden");
            if (submitBtn) submitBtn.disabled = false;
            if (spinner) spinner.style.display = "";
            if (sentText) sentText.style.display = "none";
        }
        reset();
        addEventListener("pageshow", reset);

        // Scroll form into view smoothly when keyboard opens
        function scrollFormIntoView() {
            if (!formCard) return;

            // Small delay to let keyboard fully open
            setTimeout(() => {
                formCard.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                });
            }, 100);
        }

        // Scroll back to center when keyboard closes
        function scrollToCenter() {
            if (!page) return;

            setTimeout(() => {
                window.scrollTo({
                    top: 0,
                    behavior: "smooth",
                });
            }, 50);
        }

        // Name input focus - scroll to show form
        nameInput?.addEventListener("focus", () => {
            isKeyboardOpen = true;
            scrollFormIntoView();
        });

        // Guests input focus - don't scroll, keyboard already open
        guestsInput?.addEventListener("focus", () => {
            isKeyboardOpen = true;
            // Don't scroll - keep view as is
        });

        // Handle blur on both inputs
        function handleBlur() {
            // Small delay to check if focus moved to another input
            setTimeout(() => {
                const active = document.activeElement;
                const isInputFocused =
                    active === nameInput || active === guestsInput;

                if (!isInputFocused) {
                    isKeyboardOpen = false;
                    scrollToCenter();
                }
            }, 100);
        }

        nameInput?.addEventListener("blur", handleBlur);
        guestsInput?.addEventListener("blur", handleBlur);

        // Handle visualViewport changes (keyboard show/hide)
        if (window.visualViewport) {
            window.visualViewport.addEventListener("resize", () => {
                // If viewport grew (keyboard closed), scroll to center
                if (window.visualViewport!.height > window.innerHeight * 0.8) {
                    if (isKeyboardOpen) {
                        isKeyboardOpen = false;
                        scrollToCenter();
                    }
                }
            });
        }

        // Get selected attendance
        const getAttending = () =>
            (
                document.querySelector(
                    'input[name="attending"]:checked',
                ) as HTMLInputElement
            )?.value || "yes";

        // Toggle guests visibility
        function updateGuests() {
            guestsWrap?.classList.toggle("show", getAttending() === "yes");
        }

        // Load saved form data
        try {
            const saved = JSON.parse(localStorage.getItem(KEY) || "{}");
            if (saved.name) nameInput.value = saved.name;
            if (saved.guests) guestsInput.value = saved.guests;
            if (saved.attending) {
                const r = document.querySelector(
                    `input[value="${saved.attending}"]`,
                ) as HTMLInputElement;
                if (r) r.checked = true;
            }
            updateGuests();
        } catch {}

        // Debounced save
        let saveTimer: ReturnType<typeof setTimeout>;
        function save() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                localStorage.setItem(
                    KEY,
                    JSON.stringify({
                        name: nameInput.value,
                        attending: getAttending(),
                        guests: guestsInput.value,
                    }),
                );
            }, 200);
        }

        // Input handlers
        nameInput?.addEventListener("input", save);

        // Guests input - keep only last digit (0-9)
        guestsInput?.addEventListener("input", () => {
            let val = guestsInput.value.replace(/[^0-9]/g, "");
            if (val.length > 1) val = val.slice(-1);
            if (val === "") val = "0";
            guestsInput.value = val;
            save();
        });

        // Radio change - don't affect keyboard
        radios.forEach((r) =>
            r.addEventListener("change", () => {
                updateGuests();
                save();
                // Keep focus where it is, don't close keyboard
            }),
        );

        // Form submission
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Blur to dismiss keyboard
            (document.activeElement as HTMLElement)?.blur();

            // Show loader with spinner
            loader?.classList.remove("hidden");
            if (spinner) spinner.style.display = "";
            if (sentText) sentText.style.display = "none";
            error?.classList.add("hidden");
            if (submitBtn) submitBtn.disabled = true;

            const coming = getAttending() === "yes";

            try {
                await fetch(API, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify({
                        name: nameInput.value.trim(),
                        attending: coming ? "Yes" : "No",
                        guests: coming ? +guestsInput.value : 0,
                    }),
                });

                localStorage.removeItem(KEY);

                // Smooth transition to "RSVP sent!"
                if (spinner) {
                    spinner.style.transition = "opacity 0.2s ease";
                    spinner.style.opacity = "0";
                }

                setTimeout(() => {
                    if (spinner) spinner.style.display = "none";
                    if (sentText) {
                        sentText.style.display = "";
                        sentText.style.opacity = "0";
                        sentText.style.transition = "opacity 0.3s ease";
                        requestAnimationFrame(() => {
                            sentText.style.opacity = "1";
                        });
                    }
                }, 200);

                // Navigate after showing success message
                setTimeout(() => navigate(redirect), 1000);
            } catch {
                error?.classList.remove("hidden");
                loader?.classList.add("hidden");
                if (submitBtn) submitBtn.disabled = false;
            }
        });
    }

    init();
    document.addEventListener("astro:page-load", init);
</script>

<style>
    /* Page scrollable */
    .page {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .form-card {
        text-align: left;
        scroll-margin-top: var(--space-4);
    }

    [dir="rtl"] .form-card {
        text-align: right;
    }

    .field {
        display: block;
        margin-bottom: var(--space-5);
    }

    .label {
        display: block;
        font-size: var(--fs-base);
        color: var(--white-90);
        margin-bottom: var(--space-2);
        font-weight: 500;
    }

    /* Radio buttons */
    .radio-group {
        display: flex;
        gap: var(--space-3);
    }

    .radio {
        flex: 1;
        cursor: pointer;
    }

    .radio input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .radio-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 52px;
        padding: var(--space-4);
        font-size: var(--fs-base);
        font-weight: 600;
        color: var(--white);
        background: var(--white-10);
        border: 1px solid var(--white-20);
        border-radius: var(--radius-sm);
        transition: all var(--duration) var(--ease);
    }

    .radio:active .radio-btn {
        transform: scale(0.97);
    }

    .radio input:checked + .yes {
        background: var(--success);
        border-color: var(--success);
    }

    .radio input:checked + .no {
        background: var(--error);
        border-color: var(--error);
    }

    /* Guests expandable section */
    .guests-wrap {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.2s var(--ease);
    }

    .guests-wrap.show {
        grid-template-rows: 1fr;
    }

    .guests-wrap > * {
        overflow: hidden;
    }

    .submit {
        margin-top: var(--space-2);
        font-size: var(--fs-lg);
    }

    .error {
        text-align: center;
        color: #f99;
        font-size: var(--fs-base);
        margin-top: var(--space-4);
    }

    /* Loader overlay */
    .loader {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(75, 1, 1, 0.96);
        z-index: 999;
        opacity: 1;
        transition: opacity 0.2s var(--ease);
    }

    .loader.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .spinner {
        width: 2.25rem;
        height: 2.25rem;
        border: 2.5px solid var(--white-20);
        border-top-color: var(--white);
        border-radius: 50%;
        animation: spin 0.5s linear infinite;
    }

    .sent-text {
        display: none;
        font-size: var(--fs-xl);
        font-weight: 500;
        color: #4ade80;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
