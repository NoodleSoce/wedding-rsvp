---
// Confetti - optimized, only plays if user accepted
---

<script>
  let hasPlayed = false;
  let confettiModule: typeof import("canvas-confetti") | null = null;

  async function run() {
    // Prevent running twice
    if (hasPlayed) return;

    const page = document.querySelector(".page[data-target]");
    if (!page) return;

    // Reduced motion check
    if (matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    // Don't play if declined
    if (sessionStorage.getItem("rsvp_declined") === "true") return;

    hasPlayed = true;

    // Lazy load confetti only when needed
    if (!confettiModule) {
      confettiModule = await import("canvas-confetti");
    }
    const confetti = confettiModule.default;

    // Get content area bounds once
    const content = page.querySelector(".content");
    const rect = content?.getBoundingClientRect();
    if (!rect) return;

    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const left = rect.left / vw;
    const right = rect.right / vw;
    const width = right - left;
    const top = rect.top / vh;

    // Reduced duration and particle count for better performance
    const duration = 3000;
    const end = Date.now() + duration;

    // Use requestAnimationFrame for smoother, battery-efficient animation
    let frameId: number;

    function burst() {
      const now = Date.now();
      if (now > end) {
        cancelAnimationFrame(frameId);
        return;
      }

      // Reduced particle count for performance
      confetti({
        particleCount: 8,
        spread: 45,
        startVelocity: 8,
        ticks: 60,
        gravity: 0.7,
        origin: {
          x: left + Math.random() * width,
          y: top + Math.random() * 0.25,
        },
        zIndex: 0,
        disableForReducedMotion: true,
      });

      // Burst every ~250ms using RAF timing
      setTimeout(() => {
        frameId = requestAnimationFrame(burst);
      }, 250);
    }

    burst();
  }

  // Cleanup on page swap
  document.addEventListener("astro:before-swap", () => {
    hasPlayed = false;
    if (confettiModule?.default?.reset) {
      confettiModule.default.reset();
    }
  });

  // Start after page load with minimal delay
  document.addEventListener("astro:page-load", () => {
    // Use requestIdleCallback for non-blocking initialization
    if ("requestIdleCallback" in window) {
      requestIdleCallback(() => run(), { timeout: 500 });
    } else {
      setTimeout(run, 200);
    }
  });
</script>
