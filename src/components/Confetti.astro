---
// Confetti - only plays if user accepted (not declined)
---

<script>
  import confetti from "canvas-confetti";

  let timer: number;
  let hasPlayed = false;

  function run() {
    // Prevent running twice
    if (hasPlayed) return;

    const page = document.querySelector(".page[data-target]");
    if (!page) return;
    if (matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    // Don't play confetti if user declined
    if (sessionStorage.getItem("rsvp_declined") === "true") return;

    hasPlayed = true;

    // Get content area bounds
    const content = page.querySelector(".content");
    const rect = content?.getBoundingClientRect();

    if (!rect) return;

    const contentLeft = rect.left / window.innerWidth;
    const contentRight = rect.right / window.innerWidth;
    const contentWidth = contentRight - contentLeft;
    const contentTop = rect.top / window.innerHeight;

    const end = Date.now() + 4500;

    clearInterval(timer);
    timer = setInterval(() => {
      if (Date.now() > end) return clearInterval(timer);

      const randomX = contentLeft + Math.random() * contentWidth;
      const randomY = contentTop + Math.random() * 0.3;

      confetti({
        particleCount: 12,
        spread: 50,
        startVelocity: 10,
        ticks: 80,
        gravity: 0.6,
        origin: { x: randomX, y: randomY },
        zIndex: 0,
      });
    }, 300) as unknown as number;
  }

  document.addEventListener("astro:before-swap", () => {
    clearInterval(timer);
    confetti.reset?.();
    hasPlayed = false;
  });

  document.addEventListener("astro:page-load", () => {
    requestAnimationFrame(() => setTimeout(run, 300));
  });
</script>
