---
// Confetti - optimized, only plays if user accepted
---

<script>
  import confetti from "canvas-confetti";

  let hasPlayed = false;
  let intervalId: number | undefined;

  function run() {
    // Prevent running twice
    if (hasPlayed) return;

    const page = document.querySelector(".page[data-target]");
    if (!page) return;

    // Reduced motion check
    if (matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    // Don't play if declined
    if (sessionStorage.getItem("rsvp_declined") === "true") return;

    hasPlayed = true;

    // Get viewport dimensions once
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    // Duration
    const duration = 4000;
    const end = Date.now() + duration;

    function burst() {
      const now = Date.now();
      if (now > end) {
        if (intervalId) clearInterval(intervalId);
        return;
      }

      // Bigger confetti area - covers more of the screen
      confetti({
        particleCount: 10,
        spread: 70,
        startVelocity: 12,
        ticks: 80,
        gravity: 0.6,
        scalar: 1.1,
        origin: {
          x: 0.1 + Math.random() * 0.8, // 10% to 90% of screen width
          y: 0.1 + Math.random() * 0.3, // 10% to 40% of screen height
        },
        zIndex: 0,
        disableForReducedMotion: true,
      });
    }

    // Start immediately then repeat
    burst();
    intervalId = setInterval(burst, 280) as unknown as number;
  }

  // Cleanup on page swap
  document.addEventListener("astro:before-swap", () => {
    hasPlayed = false;
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = undefined;
    }
    confetti.reset();
  });

  // Start after page load - run immediately for responsiveness
  document.addEventListener("astro:page-load", () => {
    // Small delay to let page render first
    requestAnimationFrame(() => {
      setTimeout(run, 100);
    });
  });
</script>
