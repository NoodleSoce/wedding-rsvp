---
---

<canvas id="confetti-canvas"></canvas>

<script>
  import confetti from "canvas-confetti";

  let confettiInterval: number | undefined;

  function runConfetti() {
    const canvas = document.getElementById("confetti-canvas") as HTMLCanvasElement;
    if (!canvas) return;

    // Use a local instance on our canvas
    const myConfetti = confetti.create(canvas, {
      resize: true,
      useWorker: true,
    });

    // Respect reduced motion preferences
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)",
    ).matches;
    if (prefersReducedMotion) return;

    const duration = 3000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

    function randomInRange(min: number, max: number) {
      return Math.random() * (max - min) + min;
    }

    // Clear any existing interval
    if (confettiInterval) clearInterval(confettiInterval);

    // Fire confetti
    confettiInterval = setInterval(function () {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) {
        if (confettiInterval) clearInterval(confettiInterval);
        return;
      }

      const particleCount = 40 * (timeLeft / duration);

      myConfetti({
        ...defaults,
        particleCount,
        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 },
      });
      myConfetti({
        ...defaults,
        particleCount,
        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 },
      });
    }, 250) as unknown as number;
  }

  function scheduleConfetti() {
      // Run immediately
      runConfetti();
  }

  document.addEventListener("astro:page-load", scheduleConfetti);
  document.addEventListener("astro:before-swap", () => {
    if (confettiInterval) clearInterval(confettiInterval);
  });
</script>

<style>
  #confetti-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999; /* Ensure it is on top of everything */
  }
</style>
