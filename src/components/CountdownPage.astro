---
import Layout from "../layouts/Layout.astro";
import Confetti from "./Confetti.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
// Pre-compute target date at build time
const targetDate = new Date("2026-03-21T19:00:00+04:00").getTime();
---

<Layout title={lang === "ar" ? "العد التنازلي" : "Countdown"} lang={lang}>
    <Confetti />
    <main
        class="page fade"
        data-target={targetDate}
        data-expired={t["countdown.expired"]}
        data-title-declined={t["countdown.titleDeclined"]}
    >
        <div class="content countdown">
            <h1 class="title anim anim-1" id="countdown-title">
                {t["countdown.title"]}
            </h1>

            <div
                class="timer anim anim-2"
                id="timer"
                role="timer"
                aria-live="polite"
            >
                <div class="unit">
                    <span id="days">--</span>
                    <small>{t["countdown.days"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="hours">--</span>
                    <small>{t["countdown.hours"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="minutes">--</span>
                    <small>{t["countdown.minutes"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="seconds">--</span>
                    <small>{t["countdown.seconds"]}</small>
                </div>
            </div>

            <div class="card location anim anim-3">
                <h2>{t["countdown.location"]}</h2>
                <p class="city">{t["countdown.city"]}</p>
                <div class="map" id="map-container">
                    <div class="map-placeholder" id="map-placeholder">
                        Loading map...
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    // Optimized countdown with minimal DOM access
    let timer: number | undefined;
    let initialized = false;

    // Cache DOM elements
    let els: {
        d: HTMLElement | null;
        h: HTMLElement | null;
        m: HTMLElement | null;
        s: HTMLElement | null;
        timer: HTMLElement | null;
    };

    function init() {
        if (initialized) return;

        const page = document.querySelector(
            ".page[data-target]",
        ) as HTMLElement;
        if (!page) return;

        initialized = true;

        // Cache all elements once
        els = {
            timer: document.getElementById("timer"),
            d: document.getElementById("days"),
            h: document.getElementById("hours"),
            m: document.getElementById("minutes"),
            s: document.getElementById("seconds"),
        };

        // Update title if declined
        const titleEl = document.getElementById("countdown-title");
        if (sessionStorage.getItem("rsvp_declined") === "true" && titleEl) {
            titleEl.textContent =
                page.dataset.titleDeclined || titleEl.textContent;
        }

        // Parse target once
        const target = Number(page.dataset.target);
        const expired = page.dataset.expired || "Started!";

        // Pre-calculate constants for faster math
        const DAY = 86400000;
        const HOUR = 3600000;
        const MIN = 60000;
        const SEC = 1000;

        // Last values to prevent unnecessary DOM updates
        let lastD = "",
            lastH = "",
            lastM = "",
            lastS = "";

        function tick() {
            const diff = target - Date.now();

            if (diff <= 0) {
                if (els.timer)
                    els.timer.innerHTML = `<span class="done">${expired}</span>`;
                if (timer) clearInterval(timer);
                return;
            }

            // Fast integer math
            const d = String((diff / DAY) | 0).padStart(2, "0");
            const h = String(((diff % DAY) / HOUR) | 0).padStart(2, "0");
            const m = String(((diff % HOUR) / MIN) | 0).padStart(2, "0");
            const s = String(((diff % MIN) / SEC) | 0).padStart(2, "0");

            // Only update DOM if value changed
            if (d !== lastD && els.d) {
                els.d.textContent = d;
                lastD = d;
            }
            if (h !== lastH && els.h) {
                els.h.textContent = h;
                lastH = h;
            }
            if (m !== lastM && els.m) {
                els.m.textContent = m;
                lastM = m;
            }
            if (s !== lastS && els.s) {
                els.s.textContent = s;
                lastS = s;
            }
        }

        // Initial tick immediately
        tick();

        // Clear any existing timer
        if (timer) clearInterval(timer);
        timer = setInterval(tick, 1000) as unknown as number;

        // Auto-load map after page is interactive
        const mapContainer = document.getElementById("map-container");
        const placeholder = document.getElementById("map-placeholder");

        if (mapContainer && placeholder) {
            // Use requestIdleCallback for non-blocking load, fallback to setTimeout
            const loadMapDeferred = () => {
                if (mapContainer.querySelector("iframe")) return; // Already loaded

                const iframe = document.createElement("iframe");
                iframe.src =
                    "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3610.178!2d55.2744!3d25.1972!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5f43348a67e24b%3A0xff45e502e1ceb7e2!2sBurj%20Khalifa!5e0!3m2!1sen!2sae!4v1703634000000!5m2!1sen!2sae";
                iframe.loading = "lazy";
                iframe.title = "Location";
                iframe.style.cssText = "width:100%;height:100%;border:0;";
                placeholder.remove();
                mapContainer.appendChild(iframe);
            };

            if ("requestIdleCallback" in window) {
                requestIdleCallback(loadMapDeferred, { timeout: 1000 });
            } else {
                setTimeout(loadMapDeferred, 500);
            }
        }
    }

    // Cleanup
    document.addEventListener("astro:before-swap", () => {
        if (timer) clearInterval(timer);
        initialized = false;
    });

    document.addEventListener("astro:page-load", init);
</script>

<style>
    .countdown {
        gap: var(--space-5);
    }

    .title {
        font-size: var(--fs-xl);
        font-weight: 300;
        max-width: min(90%, 380px);
        line-height: 1.35;
        padding: 0 var(--space-4);
    }

    .timer {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        contain: layout style;
    }

    .unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: clamp(40px, 10vw, 56px);
    }

    .unit span {
        font-size: clamp(1.5rem, 1.2rem + 1.5vw, 2.25rem);
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        line-height: 1;
    }

    .unit small {
        font-size: var(--fs-sm);
        color: var(--white-70);
        margin-top: var(--space-2);
    }

    .sep {
        font-size: clamp(1.25rem, 1rem + 1vw, 1.75rem);
        font-weight: 700;
        color: var(--white-70);
        margin-bottom: var(--space-6);
    }

    .location h2 {
        font-size: var(--fs-lg);
        text-align: center;
        margin-bottom: var(--space-2);
    }

    .city {
        font-size: var(--fs-base);
        color: var(--white-70);
        text-align: center;
        margin-bottom: var(--space-4);
    }

    .map {
        border-radius: var(--radius-sm);
        overflow: hidden;
        height: clamp(120px, 20vh, 180px);
        min-height: 100px;
        box-shadow: var(--shadow);
        background: var(--white-10);
        contain: layout paint;
    }

    .map-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--white-50);
        font-size: var(--fs-sm);
    }

    @media (orientation: landscape) and (max-height: 500px) {
        .map {
            height: clamp(100px, 30vw, 160px);
        }
    }

    .done {
        font-size: var(--fs-xl);
        font-weight: 600;
    }
</style>
