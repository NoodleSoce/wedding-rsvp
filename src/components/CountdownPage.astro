---
import Layout from "../layouts/Layout.astro";
import Confetti from "./Confetti.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const targetDate = new Date("2026-03-21T19:00:00+04:00").getTime();
---

<Layout title={lang === "ar" ? "العد التنازلي" : "Countdown"} lang={lang}>
    <Confetti />
    <main
        class="page fade-in"
        data-target={targetDate}
        data-expired={t["countdown.expired"]}
    >
        <div class="page-content">
            <h1 class="title anim anim-1">{t["countdown.title"]}</h1>

            <div class="timer anim anim-2" id="timer">
                <div class="unit">
                    <span id="days">00</span>
                    <small>{t["countdown.days"]}</small>
                </div>
                <span class="sep">:</span>
                <div class="unit">
                    <span id="hours">00</span>
                    <small>{t["countdown.hours"]}</small>
                </div>
                <span class="sep">:</span>
                <div class="unit">
                    <span id="minutes">00</span>
                    <small>{t["countdown.minutes"]}</small>
                </div>
                <span class="sep">:</span>
                <div class="unit">
                    <span id="seconds">00</span>
                    <small>{t["countdown.seconds"]}</small>
                </div>
            </div>

            <div class="location card anim anim-3">
                <h2>{t["countdown.location"]}</h2>
                <p>{t["countdown.city"]}</p>
                <div class="map anim anim-4">
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3610.178!2d55.2744!3d25.1972!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5f43348a67e24b%3A0xff45e502e1ceb7e2!2sBurj%20Khalifa!5e0!3m2!1sen!2sae!4v1703634000000!5m2!1sen!2sae"
                        loading="lazy"
                        title="Wedding venue"></iframe>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    let interval: number;

    function init() {
        const page = document.querySelector(
            ".page[data-target]",
        ) as HTMLElement;
        if (!page) return;

        const target = Number(page.dataset.target);
        const expired = page.dataset.expired || "EXPIRED";
        const timer = document.getElementById("timer");
        const els = {
            days: document.getElementById("days"),
            hours: document.getElementById("hours"),
            minutes: document.getElementById("minutes"),
            seconds: document.getElementById("seconds"),
        };

        let prev = { d: -1, h: -1, m: -1, s: -1 };

        function tick() {
            const diff = target - Date.now();
            if (diff < 0) {
                if (timer) timer.innerHTML = expired;
                clearInterval(interval);
                return;
            }

            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);

            if (d !== prev.d && els.days) {
                els.days.textContent = String(d).padStart(2, "0");
                prev.d = d;
            }
            if (h !== prev.h && els.hours) {
                els.hours.textContent = String(h).padStart(2, "0");
                prev.h = h;
            }
            if (m !== prev.m && els.minutes) {
                els.minutes.textContent = String(m).padStart(2, "0");
                prev.m = m;
            }
            if (s !== prev.s && els.seconds) {
                els.seconds.textContent = String(s).padStart(2, "0");
                prev.s = s;
            }
        }

        tick();
        if (interval) clearInterval(interval);
        interval = setInterval(tick, 1000) as unknown as number;
    }

    init();
    document.addEventListener("astro:page-load", init);
    document.addEventListener("astro:before-swap", () =>
        clearInterval(interval),
    );
</script>

<style>
    .page-content {
        gap: var(--s-4);
    }

    @media (min-width: 480px) {
        .page-content {
            gap: var(--s-6);
        }
    }

    .title {
        font-size: clamp(1.25rem, 4vw, 1.75rem);
        font-weight: 300;
        line-height: 1.3;
        max-width: 500px;
        padding: 0 var(--s-2);
    }

    @media (min-width: 480px) {
        .title {
            font-size: clamp(1.4rem, 3.5vw, 2rem);
        }
    }

    .timer {
        display: flex;
        align-items: center;
        gap: var(--s-1);
    }

    @media (min-width: 480px) {
        .timer {
            gap: var(--s-2);
        }
    }

    .unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 36px;
    }

    @media (min-width: 480px) {
        .unit {
            min-width: 44px;
        }
    }

    .unit span {
        font-size: clamp(1.25rem, 3.5vw, 2rem);
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        line-height: 1;
    }

    .unit small {
        font-size: var(--fs-sm);
        color: var(--c-white-80);
        margin-top: var(--s-1);
    }

    .sep {
        font-size: clamp(1rem, 2.5vw, 1.5rem);
        color: var(--c-white-50);
        padding-bottom: var(--s-4);
    }

    @media (min-width: 480px) {
        .sep {
            padding-bottom: var(--s-6);
        }
    }

    .location {
        width: 100%;
        text-align: center;
    }

    .location h2 {
        font-size: var(--fs-lg);
        margin-bottom: var(--s-1);
    }

    .location p {
        color: var(--c-white-80);
        margin-bottom: var(--s-3);
    }

    @media (min-width: 480px) {
        .location p {
            margin-bottom: var(--s-4);
        }
    }

    .map {
        border-radius: var(--s-2);
        overflow: hidden;
        height: 20vh;
        min-height: 120px;
        max-height: 150px;
        box-shadow: var(--shadow);
    }

    @media (min-width: 480px) {
        .map {
            height: 22vh;
            max-height: 180px;
        }
    }

    .map iframe {
        width: 100%;
        height: 100%;
        border: 0;
    }
</style>
