---
import Layout from "../layouts/Layout.astro";
import Confetti from "./Confetti.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const targetDate = new Date("2026-03-21T19:00:00+04:00").getTime();
---

<Layout title={lang === "ar" ? "العد التنازلي" : "Countdown"} lang={lang}>
    <Confetti />
    <main
        class="page fade"
        data-target={targetDate}
        data-expired={t["countdown.expired"]}
    >
        <div class="content">
            <h1 class="anim anim-1">{t["countdown.title"]}</h1>

            <div
                class="timer anim anim-2"
                id="timer"
                role="timer"
                aria-live="polite"
                aria-atomic="false"
            >
                <div class="unit">
                    <span id="days" aria-label={t["countdown.days"]}>00</span>
                    <small>{t["countdown.days"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="hours" aria-label={t["countdown.hours"]}>00</span>
                    <small>{t["countdown.hours"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="minutes" aria-label={t["countdown.minutes"]}
                        >00</span
                    >
                    <small>{t["countdown.minutes"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="seconds" aria-label={t["countdown.seconds"]}
                        >00</span
                    >
                    <small>{t["countdown.seconds"]}</small>
                </div>
            </div>

            <div class="card anim anim-3">
                <h2>{t["countdown.location"]}</h2>
                <p class="city">{t["countdown.city"]}</p>
                <div class="map">
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3610.178!2d55.2744!3d25.1972!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5f43348a67e24b%3A0xff45e502e1ceb7e2!2sBurj%20Khalifa!5e0!3m2!1sen!2sae!4v1703634000000!5m2!1sen!2sae"
                        loading="lazy"
                        title={t["countdown.location"]}
                        allow="fullscreen"></iframe>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    let intervalId: number | undefined;

    function initCountdown() {
        const page = document.querySelector(
            ".page[data-target]",
        ) as HTMLElement;
        if (!page) return;

        const targetTime = Number(page.dataset.target);
        const expiredText = page.dataset.expired || "Event Started!";
        const timerEl = document.getElementById("timer");

        const daysEl = document.getElementById("days");
        const hoursEl = document.getElementById("hours");
        const minutesEl = document.getElementById("minutes");
        const secondsEl = document.getElementById("seconds");

        // Cache previous values to avoid unnecessary DOM updates
        let prev = { d: -1, h: -1, m: -1, s: -1 };

        function updateTimer() {
            const now = Date.now();
            const diff = targetTime - now;

            if (diff <= 0) {
                if (timerEl)
                    timerEl.innerHTML = `<span class="expired">${expiredText}</span>`;
                if (intervalId) clearInterval(intervalId);
                return;
            }

            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            // Only update DOM if value changed
            if (days !== prev.d && daysEl) {
                daysEl.textContent = String(days).padStart(2, "0");
                prev.d = days;
            }
            if (hours !== prev.h && hoursEl) {
                hoursEl.textContent = String(hours).padStart(2, "0");
                prev.h = hours;
            }
            if (minutes !== prev.m && minutesEl) {
                minutesEl.textContent = String(minutes).padStart(2, "0");
                prev.m = minutes;
            }
            if (seconds !== prev.s && secondsEl) {
                secondsEl.textContent = String(seconds).padStart(2, "0");
                prev.s = seconds;
            }
        }

        // Run immediately
        updateTimer();

        // Clear any existing interval
        if (intervalId) clearInterval(intervalId);

        // Start interval
        intervalId = setInterval(updateTimer, 1000) as unknown as number;
    }

    // Initialize
    initCountdown();
    document.addEventListener("astro:page-load", initCountdown);
    document.addEventListener("astro:before-swap", () => {
        if (intervalId) clearInterval(intervalId);
    });
</script>

<style>
    .content {
        gap: var(--gap-lg);
    }

    h1 {
        font-size: var(--fs-xl);
        font-weight: 300;
        max-width: 320px;
        line-height: 1.35;
    }

    @media (min-width: 400px) {
        h1 {
            max-width: 380px;
        }
    }

    .timer {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    @media (min-width: 400px) {
        .timer {
            gap: 0.5rem;
        }
    }

    .unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 36px;
    }

    @media (min-width: 400px) {
        .unit {
            min-width: 44px;
        }
    }

    .unit span {
        font-size: 1.5rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        line-height: 1;
    }

    @media (min-width: 400px) {
        .unit span {
            font-size: 1.875rem;
        }
    }

    .unit small {
        font-size: var(--fs-xs);
        color: var(--c-white-70);
        margin-top: 0.25rem;
    }

    .sep {
        font-size: 1rem;
        color: var(--c-white-40);
        margin-bottom: 1rem;
    }

    @media (min-width: 400px) {
        .sep {
            font-size: 1.25rem;
        }
    }

    .card {
        width: 100%;
        text-align: center;
    }

    .card h2 {
        font-size: var(--fs-lg);
        margin-bottom: 0.25rem;
    }

    .city {
        font-size: var(--fs-sm);
        color: var(--c-white-70);
        margin-bottom: var(--gap);
    }

    .map {
        border-radius: var(--radius-sm);
        overflow: hidden;
        height: 130px;
        box-shadow: var(--shadow);
    }

    @media (min-width: 400px) {
        .map {
            height: 150px;
        }
    }

    .map iframe {
        width: 100%;
        height: 100%;
        border: 0;
    }

    .expired {
        font-size: var(--fs-xl);
        font-weight: 600;
    }
</style>
