---
import Layout from "../layouts/Layout.astro";
import Confetti from "./Confetti.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const targetDate = new Date("2026-03-21T19:00:00+04:00").getTime();
---

<Layout title={lang === "ar" ? "العد التنازلي" : "Countdown"} lang={lang}>
    <Confetti />
    <main
        class="page fade"
        data-target={targetDate}
        data-expired={t["countdown.expired"]}
    >
        <div class="content countdown">
            <h1 class="title anim anim-1">{t["countdown.title"]}</h1>

            <!-- BIGGER timer for app-like feel -->
            <div class="timer anim anim-2" id="timer" role="timer">
                <div class="unit">
                    <span id="days">00</span>
                    <small>{t["countdown.days"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="hours">00</span>
                    <small>{t["countdown.hours"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="minutes">00</span>
                    <small>{t["countdown.minutes"]}</small>
                </div>
                <span class="sep" aria-hidden="true">:</span>
                <div class="unit">
                    <span id="seconds">00</span>
                    <small>{t["countdown.seconds"]}</small>
                </div>
            </div>

            <div class="card location anim anim-3">
                <h2>{t["countdown.location"]}</h2>
                <p class="city">{t["countdown.city"]}</p>
                <div class="map">
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3610.178!2d55.2744!3d25.1972!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5f43348a67e24b%3A0xff45e502e1ceb7e2!2sBurj%20Khalifa!5e0!3m2!1sen!2sae!4v1703634000000!5m2!1sen!2sae"
                        loading="lazy"
                        title={t["countdown.location"]}></iframe>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    let timer: number | undefined;

    function init() {
        const page = document.querySelector(
            ".page[data-target]",
        ) as HTMLElement;
        if (!page) return;

        const target = Number(page.dataset.target);
        const expired = page.dataset.expired || "Started!";
        const el = {
            timer: document.getElementById("timer"),
            d: document.getElementById("days"),
            h: document.getElementById("hours"),
            m: document.getElementById("minutes"),
            s: document.getElementById("seconds"),
        };

        let last = { d: -1, h: -1, m: -1, s: -1 };

        function tick() {
            const diff = target - Date.now();
            if (diff <= 0) {
                if (el.timer)
                    el.timer.innerHTML = `<span class="done">${expired}</span>`;
                if (timer) clearInterval(timer);
                return;
            }

            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);

            if (d !== last.d && el.d) {
                el.d.textContent = String(d).padStart(2, "0");
                last.d = d;
            }
            if (h !== last.h && el.h) {
                el.h.textContent = String(h).padStart(2, "0");
                last.h = h;
            }
            if (m !== last.m && el.m) {
                el.m.textContent = String(m).padStart(2, "0");
                last.m = m;
            }
            if (s !== last.s && el.s) {
                el.s.textContent = String(s).padStart(2, "0");
                last.s = s;
            }
        }

        tick();
        if (timer) clearInterval(timer);
        timer = setInterval(tick, 1000) as unknown as number;
    }

    init();
    document.addEventListener("astro:page-load", init);
    document.addEventListener(
        "astro:before-swap",
        () => timer && clearInterval(timer),
    );
</script>

<style>
    .countdown {
        gap: var(--space-6);
    }

    .title {
        font-size: var(--fs-xl);
        font-weight: 300;
        max-width: min(90%, 400px);
        line-height: 1.35;
    }

    /* BIGGER timer numbers for app-like feel */
    .timer {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: clamp(44px, 38px + 2vw, 64px);
    }

    .unit span {
        font-size: clamp(1.75rem, 1.4rem + 1.75vw, 2.75rem);
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        line-height: 1;
    }

    .unit small {
        font-size: var(--fs-sm);
        color: var(--white-70);
        margin-top: var(--space-2);
    }

    .sep {
        font-size: clamp(1.25rem, 1rem + 0.75vw, 1.75rem);
        color: var(--white-50);
        margin-bottom: var(--space-6);
    }

    .location h2 {
        font-size: var(--fs-lg);
        text-align: center;
        margin-bottom: var(--space-2);
    }

    .city {
        font-size: var(--fs-base);
        color: var(--white-70);
        text-align: center;
        margin-bottom: var(--space-4);
    }

    .map {
        border-radius: var(--radius-sm);
        overflow: hidden;
        height: clamp(120px, 22vh, 200px);
        box-shadow: var(--shadow);
    }

    .map iframe {
        width: 100%;
        height: 100%;
        border: 0;
    }

    .done {
        font-size: var(--fs-2xl);
        font-weight: 600;
    }
</style>
