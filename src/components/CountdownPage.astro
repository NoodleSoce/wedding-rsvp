---
import Layout from "../layouts/Layout.astro";
import Confetti from "./Confetti.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];

// Target Date: Saturday March 21, 2026 at 7:00 PM Dubai Time (UTC+4)
// ISO string with offset ensures correct absolute time regardless of user location
const targetDate = new Date("2026-03-21T19:00:00+04:00").getTime();
---

<Layout title={lang === "ar" ? "العد التنازلي" : "Countdown"} lang={lang}>
    <Confetti />
    <main
        class="countdown-page fade-in"
        data-target-date={targetDate}
        data-expired-text={t["countdown.expired"]}
    >
        <div class="content block">
            <h1 class="stagger-1">
                {t["countdown.title"]}
            </h1>
            <div id="countdown" class="timer stagger-2">
                <div class="time-unit">
                    <span id="days">00</span>
                    <label>{t["countdown.days"]}</label>
                </div>
                <div class="separator">:</div>
                <div class="time-unit">
                    <span id="hours">00</span>
                    <label>{t["countdown.hours"]}</label>
                </div>
                <div class="separator">:</div>
                <div class="time-unit">
                    <span id="minutes">00</span>
                    <label>{t["countdown.minutes"]}</label>
                </div>
                <div class="separator">:</div>
                <div class="time-unit">
                    <span id="seconds">00</span>
                    <label>{t["countdown.seconds"]}</label>
                </div>
            </div>
            <div class="location-section stagger-3">
                <h2>{t["countdown.location"]}</h2>
                <p>{t["countdown.city"]}</p>
                <div class="map-container stagger-4">
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3610.178!2d55.2744!3d25.1972!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5f43348a67e24b%3A0xff45e502e1ceb7e2!2sBurj%20Khalifa!5e0!3m2!1sen!2sae!4v1703634000000!5m2!1sen!2sae"
                        width="100%"
                        height="100%"
                        style="border:0;"
                        allowfullscreen=""
                        loading="lazy"
                        fetchpriority="low"
                        referrerpolicy="no-referrer-when-downgrade"
                        title="Wedding venue location on Google Maps"></iframe>
                </div>
            </div>
        </div>
    </main>

    <script>
        let countdownInterval: number | undefined;

        function initCountdown() {
            const container = document.querySelector(
                ".countdown-page",
            ) as HTMLElement;
            if (!container || !container.dataset.targetDate) return;

            const targetDate = Number(container.dataset.targetDate);
            const expiredText = container.dataset.expiredText || "EXPIRED";

            const daysEl = document.getElementById("days");
            const hoursEl = document.getElementById("hours");
            const minutesEl = document.getElementById("minutes");
            const secondsEl = document.getElementById("seconds");
            const countdownEl = document.getElementById("countdown");

            // Cache previous values to avoid unnecessary DOM updates
            let prevDays = -1;
            let prevHours = -1;
            let prevMinutes = -1;
            let prevSeconds = -1;

            function updateCountdown() {
                const now = Date.now();
                const distance = targetDate - now;

                if (distance < 0) {
                    if (countdownEl) countdownEl.innerHTML = expiredText;
                    if (countdownInterval) clearInterval(countdownInterval);
                    return;
                }

                const days = Math.floor(distance / 86400000);
                const hours = Math.floor((distance % 86400000) / 3600000);
                const minutes = Math.floor((distance % 3600000) / 60000);
                const seconds = Math.floor((distance % 60000) / 1000);

                // Only update DOM if value changed (reduces repaints)
                if (days !== prevDays && daysEl) {
                    daysEl.textContent = String(days).padStart(2, "0");
                    prevDays = days;
                }
                if (hours !== prevHours && hoursEl) {
                    hoursEl.textContent = String(hours).padStart(2, "0");
                    prevHours = hours;
                }
                if (minutes !== prevMinutes && minutesEl) {
                    minutesEl.textContent = String(minutes).padStart(2, "0");
                    prevMinutes = minutes;
                }
                if (seconds !== prevSeconds && secondsEl) {
                    secondsEl.textContent = String(seconds).padStart(2, "0");
                    prevSeconds = seconds;
                }
            }

            // Start immediately
            updateCountdown();

            // Clear any existing interval
            if (countdownInterval) clearInterval(countdownInterval);

            // Start new interval
            countdownInterval = setInterval(
                updateCountdown,
                1000,
            ) as unknown as number;
        }

        // Initial run
        initCountdown();

        // View Transitions Support
        document.addEventListener("astro:page-load", initCountdown);
        document.addEventListener("astro:before-swap", () => {
            if (countdownInterval) clearInterval(countdownInterval);
        });
    </script>

    <style>
        .countdown-page {
            height: 100vh;
            height: 100dvh;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
            padding-top: var(--header-height);
            overflow: hidden;
            position: fixed;
            inset: 0;
            contain: layout style paint size;
            transform: translateZ(0);
        }

        .content {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: var(--page-padding);
            padding-top: var(--space-3xl);
            padding-bottom: calc(var(--header-height) - var(--space-md));
            gap: var(--section-gap);
            content-visibility: auto;
        }

        @media (min-width: 768px) {
            .content {
                padding-bottom: var(--header-height);
                gap: var(--space-2xl);
            }
        }

        .content h1 {
            margin-bottom: var(--space-sm);
        }

        h1 {
            color: var(--color-white);
            margin-bottom: var(--space-sm);
            font-size: clamp(1.58rem, 4.6vw, 2.58rem);
            line-height: 1.15;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 0 var(--space-sm);
            font-weight: 300;
            max-width: 740px;
            width: 100%;
        }

        .timer {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            gap: var(--space-sm);
            width: fit-content;
            max-width: 100%;
        }

        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: auto;
            min-width: 40px;
            padding: 0 var(--space-xs);
        }

        .time-unit span {
            font-size: clamp(1.48rem, 4.3vw, 2.68rem);
            font-weight: 700;
            color: var(--color-white);
            line-height: 1;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            font-variant-numeric: tabular-nums;
            contain: content;
        }

        .time-unit label {
            font-size: var(--text-sm);
            color: var(--color-white-muted);
            margin-top: var(--space-xs);
        }

        .separator {
            font-size: clamp(1.3rem, 3.5vw, 2.3rem);
            margin: 0;
            padding-bottom: var(--space-lg);
            color: var(--color-white-faint);
        }

        .location-section {
            width: 100%;
            max-width: var(--max-width);
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(10px);
            margin: 0 auto;
            contain: content;
        }

        .location-section h2 {
            font-size: var(--text-lg);
            margin-bottom: var(--space-xs);
            color: var(--color-white);
            font-weight: 400;
        }

        .location-section p {
            font-size: var(--text-base);
            color: var(--color-white);
            margin-bottom: var(--space-sm);
            opacity: 0.9;
        }

        .map-container {
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin: var(--space-md) auto var(--space-sm);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 25vh;
            max-height: 200px;
            width: 94%;
        }

        iframe {
            height: 100% !important;
        }
    </style>
</Layout>
