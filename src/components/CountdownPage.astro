---
import Layout from "../layouts/Layout.astro";
import Confetti from "./Confetti.astro";
import { ui } from "../i18n/ui";

interface Props {
    lang: "en" | "ar";
}

const { lang } = Astro.props;
const t = ui[lang];
const targetDate = new Date("2026-03-21T19:00:00+04:00").getTime();
---

<Layout title={lang === "ar" ? "العد التنازلي" : "Countdown"} lang={lang}>
    <Confetti />
    <main
        class="page fade"
        data-target={targetDate}
        data-expired={t["countdown.expired"]}
    >
        <div class="content">
            <h1 class="anim anim-1">{t["countdown.title"]}</h1>

            <div class="timer anim anim-2" id="timer">
                <div class="unit">
                    <span id="days">00</span>
                    <small>{t["countdown.days"]}</small>
                </div>
                <span class="sep">:</span>
                <div class="unit">
                    <span id="hours">00</span>
                    <small>{t["countdown.hours"]}</small>
                </div>
                <span class="sep">:</span>
                <div class="unit">
                    <span id="minutes">00</span>
                    <small>{t["countdown.minutes"]}</small>
                </div>
                <span class="sep">:</span>
                <div class="unit">
                    <span id="seconds">00</span>
                    <small>{t["countdown.seconds"]}</small>
                </div>
            </div>

            <div class="card anim anim-3">
                <h2>{t["countdown.location"]}</h2>
                <p class="city">{t["countdown.city"]}</p>
                <div class="map">
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3610.178!2d55.2744!3d25.1972!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5f43348a67e24b%3A0xff45e502e1ceb7e2!2sBurj%20Khalifa!5e0!3m2!1sen!2sae!4v1703634000000!5m2!1sen!2sae"
                        loading="lazy"
                        title="Venue"></iframe>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    let interval: number;

    function init() {
        const page = document.querySelector(
            ".page[data-target]",
        ) as HTMLElement;
        if (!page) return;

        const target = Number(page.dataset.target);
        const expired = page.dataset.expired || "EXPIRED";
        const timer = document.getElementById("timer");
        const d = document.getElementById("days");
        const h = document.getElementById("hours");
        const m = document.getElementById("minutes");
        const s = document.getElementById("seconds");

        let last = { d: -1, h: -1, m: -1, s: -1 };

        function tick() {
            const diff = target - Date.now();
            if (diff < 0) {
                if (timer) timer.innerHTML = expired;
                clearInterval(interval);
                return;
            }

            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);

            if (days !== last.d && d) {
                d.textContent = String(days).padStart(2, "0");
                last.d = days;
            }
            if (hours !== last.h && h) {
                h.textContent = String(hours).padStart(2, "0");
                last.h = hours;
            }
            if (mins !== last.m && m) {
                m.textContent = String(mins).padStart(2, "0");
                last.m = mins;
            }
            if (secs !== last.s && s) {
                s.textContent = String(secs).padStart(2, "0");
                last.s = secs;
            }
        }

        tick();
        clearInterval(interval);
        interval = setInterval(tick, 1000) as unknown as number;
    }

    init();
    document.addEventListener("astro:page-load", init);
    document.addEventListener("astro:before-swap", () =>
        clearInterval(interval),
    );
</script>

<style>
    .content {
        gap: var(--gap-lg);
    }

    h1 {
        font-size: var(--fs-xl);
        font-weight: 300;
        max-width: 360px;
        line-height: 1.35;
    }

    .timer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 40px;
    }

    .unit span {
        font-size: 1.75rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        line-height: 1;
    }

    .unit small {
        font-size: var(--fs-xs);
        color: var(--c-white-70);
        margin-top: 0.25rem;
    }

    .sep {
        font-size: 1.25rem;
        color: var(--c-white-40);
        margin-bottom: 1rem;
    }

    .card {
        width: 100%;
        text-align: center;
    }

    .card h2 {
        font-size: var(--fs-lg);
        margin-bottom: 0.25rem;
    }

    .city {
        font-size: var(--fs-sm);
        color: var(--c-white-70);
        margin-bottom: var(--gap);
    }

    .map {
        border-radius: var(--radius-sm);
        overflow: hidden;
        height: 140px;
        box-shadow: var(--shadow);
    }

    .map iframe {
        width: 100%;
        height: 100%;
        border: 0;
    }

    @media (min-width: 400px) {
        .map {
            height: 160px;
        }
    }
</style>
